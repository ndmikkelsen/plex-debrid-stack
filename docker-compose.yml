services:
  # =============================================================================
  # ZURG - Real-Debrid WebDAV server
  # Organizes your Real-Debrid library and serves it via WebDAV
  # =============================================================================
  zurg:
    image: ghcr.io/debridmediamanager/zurg-testing:latest
    container_name: zurg
    restart: unless-stopped
    ports:
      - "9999:9999"
    volumes:
      - ./config/zurg/config.yml:/app/config.yml
      - ./data/zurg:/app/data
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9999/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # RCLONE - Mounts Zurg WebDAV as local filesystem
  # Makes Real-Debrid content available as a local directory
  # =============================================================================
  rclone:
    image: rclone/rclone:latest
    container_name: rclone
    restart: unless-stopped
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    devices:
      - /dev/fuse
    volumes:
      - ./config/rclone:/config/rclone
      - ./mnt:/data:rshared
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    command: >
      mount zurg: /data/zurg
      --config=/config/rclone/rclone.conf
      --allow-other
      --allow-non-empty
      --dir-cache-time=10s
      --vfs-cache-mode=full
      --vfs-cache-max-size=10G
      --vfs-cache-max-age=24h
      --vfs-read-chunk-size=128M
      --vfs-read-chunk-size-limit=1G
      --buffer-size=64M
      --poll-interval=15s
      --log-level=INFO
    depends_on:
      zurg:
        condition: service_healthy

  # =============================================================================
  # PLEX MEDIA SERVER
  # Streams your media library to all devices
  # =============================================================================
  plex:
    image: linuxserver/plex:latest
    container_name: plex
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
    volumes:
      - ./config/plex:/config
      - ./mnt/zurg:/debrid:rshared
    depends_on:
      - rclone

  # =============================================================================
  # SONARR - TV Show automation
  # Monitors for new episodes and sends requests to download
  # =============================================================================
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "8989:8989"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/sonarr:/config
      - ./mnt/zurg:/debrid:rshared

  # =============================================================================
  # RADARR - Movie automation
  # Monitors for new movies and sends requests to download
  # =============================================================================
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "7878:7878"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/radarr:/config
      - ./mnt/zurg:/debrid:rshared

  # =============================================================================
  # PROWLARR - Indexer Manager
  # Manages torrent indexers and syncs them to Sonarr/Radarr
  # =============================================================================
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "9696:9696"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/prowlarr:/config

  # =============================================================================
  # RDTCLIENT - Real-Debrid Torrent Client
  # Emulates qBittorrent API, sends torrents to Real-Debrid
  # =============================================================================
  rdtclient:
    image: rogerfar/rdtclient:latest
    container_name: rdtclient
    restart: unless-stopped
    ports:
      - "6500:6500"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/rdtclient:/data/db
      - ./mnt/zurg:/debrid:rshared
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # OVERSEERR - Request Management UI
  # User-friendly interface for requesting movies and TV shows
  # =============================================================================
  overseerr:
    image: linuxserver/overseerr:latest
    container_name: overseerr
    restart: unless-stopped
    ports:
      - "5055:5055"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./config/overseerr:/config
    depends_on:
      - sonarr
      - radarr
      - plex

  # =============================================================================
  # CLOUDFLARE TUNNEL - Secure external access (Optional)
  # Exposes Overseerr to the internet without port forwarding
  # Remove this service if not using Cloudflare Tunnel
  # =============================================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - overseerr
    profiles:
      - tunnel

networks:
  default:
    driver: bridge
